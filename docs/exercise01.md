# Exercise1: SQL DB 接続文字列の分離

## 【目次】

![](images/ex01-0000-sqldb-create.png)

1. [AppServiceのマネージドIDを発行](#appserviceのマネージドidを発行)
1. [キーコンテナーを作成](#キーコンテナーを作成)
1. [キーコンテナーのアクセス権設定](#キーコンテナーのアクセス権設定)
1. [接続文字列の分離](#接続文字列の分離)
1. [動作確認](#動作確認)


## AppServiceのマネージドIDを発行

1. App Service を開き、[設定]-[ID]を開く

1. 「システム割り当て済み」タブにおいて、状態を「オン」にして「保存」

## キーコンテナーを作成

1. Azureポータルにて「キーコンテナー」を検索

1. 「作成」

1. キーコンテナーを作成

    1. 基本

        * Key Vault 名： （任意）
        * 地域： （リソースグループに同じ）
        * 価格レベル： `Standard(標準)`
        * 論理削除： `有効`
        * 削除コンテナーの保持日数： `7`
        * 消去保護： `無効`

    1. アクセス構成

        * Azure ロールベースのアクセス制御
    
    1. ネットワーク

        * パブリックアクセスを有効： `オン`
        * すべてのネットワーク

## キーコンテナーのアクセス権設定

1. キーコンテナーを開き、[アクセス制御(IAM)]を開く

1. 「ロールの割り当ての追加」を開く（自分自身を管理者として追加）

    1. ロール

        * `キーコンテナー 管理者`

    1. メンバー

        * アクセスの割り当て先: `ユーザー、グループ、またはサービス プリンシパル`
        * メンバー： （自分自身のアカウント）

1. 「ロールの割り当ての追加」を開く（App Serviceを閲覧者として追加）

    1. ロール

        * `キーコンテナー シークレット ユーザー`

    1. メンバー

        * アクセスの割り当て先: `マネージドID`
        * メンバー：
            * マネージドID： `App Service`
            * 選択： （作成済みの App Service を選択）


## 接続文字列の分離

SQL Database を開き接続文字列を取得

1. SQL Database を開き、[設定]-[接続文字列]を開く

1. `ADO.NET (SQL認証)` にある文字列を取得、

1. `{your_password}` を書き換えてメモに控えておく


キーコンテナーを開き接続文字列を設定

1. キーコンテナーを開き、[オブジェクト]-[シークレット]を開く

1. 「生成/インポート」を開く

1. 以下の内容でシークレットを新規作成

    * アップロードオプション: `手動`
    * 名前: `SqlDb-Connection-String` （任意）
    * シークレット値: （あらかじめメモしておいたパスワード書き換え済みの接続文字列）

1. 作成したシークレットを開く

1. 現在のバージョンを開く

1. 「シークレット識別子」をメモに控えておく

App Service の設定をキーコンテナー参照に変更

1. App Service を開き、[設定]-[構成]を開く

1. 「アプリケーション設定」タブにある「接続文字列」の `MSSQLDB` を「編集」

    以下の内容に書き換える。
    ただし、 `<SECRET_URI>` 部分はあらかじめメモに控えておいた
    作成済みシークレットの「シークレット識別子」を設定する。

    ```
    @Microsoft.KeyVault(SecretUri=<SECRET_URI>)
    ```

1. 書き換え終わったら忘れず「保存」して反映させる

1. 画面を更新（ `F5` キーなど）して、接続文字列 `MSSQL` のソースが
    `キーコンテナーの参照` で **グリーン** になっていることを確認



## 動作確認

1. App Service を開き、[概要]を開く

1. 「既定のドメイン」にあるURLを別ブラウザで開く

1. 「ToDo」タブへ移動してタスク一覧が取得できていることを確認


![](images/ex01-0130-sqldb-create.png)



# 次の Exercise へ

* [マネージドIDを使った SQL DB 接続](exercise02.md)
